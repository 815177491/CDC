# 零维船用低速二冲程柴油机热力学建模、数据驱动校准与控诊协同方法（CDC）

> **章节定位与可复现性说明**：本章面向“零维（0D）物理仿真 + 参数校准 + 故障诊断 + 主动容错控制（AFTC）”的一体化研究框架，给出工程实现可复现的流程与模型细节。章节内容与代码工程 `CDC/` 一一对应：发动机模型位于 `engine/`，参数校准位于 `calibration/`，故障注入与诊断位于 `diagnosis/`，控诊协同位于 `control/`，图表与仪表盘位于 `visualization/`，完整演示入口为 `main.py`（模式 `--mode demo`）。本章中插图均来自代码运行输出，统一建议保存至工程根目录下的 `results/` 文件夹；由于本章文档位于 `docs/`，引用图片时使用相对路径 `../results/<图片名>`。

## 1 引言：从在线监测到“模型—诊断—控制”的闭环协同

船用低速二冲程柴油机具有缸径大、燃烧持续角长、换气过程复杂、工况波动与设备老化并存等特点，其性能和安全性既受燃烧与传热等机理影响，也受执行机构（喷油正时、燃油指令、增压系统等）与传感器质量影响。工程实践中，发动机的“高后果风险”主要来源于两类失效链条：一类以最高爆发压力 $P_{max}$ 超限为代表，直接关联机械应力与结构疲劳；另一类以排温异常 $T_{exh}$ 升高为代表，反映热负荷与后燃风险，且容易诱发涡轮前过温等连锁问题。因此，单纯依赖阈值告警的被动策略往往只能“发现问题”，却难以“解释原因”并“闭环抑制风险”。

与计算开销巨大的三维 CFD 相比，零维热力学模型通过把缸内复杂空间场“等效为平均状态”的方式，将求解对象降维为少量状态变量随曲轴转角的演化规律，从而能够在毫秒级完成一个循环的计算。这种特性使其非常适合作为发动机数字孪生的物理内核，进一步支撑在线校准、机理残差诊断以及主动容错控制。基于这一认识，本项目构建了一个 CDC（Calibration–Diagnosis–Control）闭环协同系统：首先用可解释的 0D 模型作为“健康参考”；其次利用船端监测数据对关键不确定参数进行三阶段解耦校准；再次基于“测量—模型”的残差生成故障特征并分类；最后根据诊断结果切换控制模式并实施安全约束下的干预，实现“诊断驱动控制”的协同闭环。

## 2 系统总体流程与软件架构

本系统在工程实现上采用“入口脚本—模块化类库—结果可视化”的组织方式，计算流程可以概括为：数据加载与预处理 → 稳态工况提取 → 三阶段校准（压缩/燃烧/传热） → 基准工况仿真 → 故障注入 → 残差诊断 → 协同控制动作计算 → 图表输出与仪表盘展示。为了避免把流程写成单纯的步骤清单，这里从数据流与信息流两个视角做更精确的描述。

从数据流视角，系统输入主要包括：几何参数（缸径、行程、缸数、有效压缩比初值、连杆比等）、运行工况（转速、扫气压力与温度、循环喷油量/燃油指令等），以及用于校准的监测 CSV 数据（例如：Pmax、Pcomp、扫气参数、排温等）。系统输出主要包括：校准后的参数集合（以 JSON 保存）、循环仿真的全量曲线（压力、温度、体积、燃烧分数等随曲轴转角变化）、诊断结果时间序列（故障类型、置信度、残差）、控制动作时间序列（VIT 调整、燃油调整、降级功率限制等），以及用于论文展示的五类图表（校准对标、P–V 示功图、故障响应、性能雷达图、放热率曲线）。

从信息流视角，关键在于“模型—诊断—控制”三者如何形成闭环：0D 模型提供健康预测 $y_{model}$；诊断模块把测量 $y_{measured}$ 与 $y_{model}$ 的偏差压缩成低维残差信号 $r$，并进一步映射成故障类型与严重度；控制模块把诊断信息与安全约束（例如 $P_{max}$ 上限）融合，决定控制模式（NORMAL/FAULT_TOLERANT/DEGRADED/EMERGENCY）并计算干预量。这样的结构使得控制不再是“只对测量误差反馈”，而是“对诊断结论与安全约束进行面向机理的干预”。

为帮助读者在论文中快速定位插图与输出文件，本章约定：所有图表统一由 `main.py --mode demo` 生成，输出目录为 `results/`；若使用 `quick_demo.py`，输出文件名以 `demo_` 开头，适用于快速验证绘图链路但不用于论文正式编号。

## 3 零维热力学模型：方程体系、角度域求解与实现细节

### 3.1 建模对象与角度约定

本项目的零维模型以“单缸控制体”为基本对象，重点求解二冲程发动机的高压闭合循环。与四冲程常见的 720° 周期不同，二冲程每转做功一次，但其高压循环通常从扫气口/排气阀关闭后开始，到下一次换气开启前结束。工程实现中，压缩起点由排气阀关闭角与扫气口关闭角两者的较晚者确定：
$$\theta_{start} = \max(\theta_{EVC},\;\theta_{SPC})$$
并在角度域上积分约 240° 的曲轴转角区间（该取值用于演示与数值效率，便于在一个窗口内覆盖压缩、燃烧与膨胀的主要阶段）。代码中把曲轴角以弧度表示为 $\theta$，同时提供用于燃烧模型的角度单位（°CA ATDC）。两者的转换关系在实现中采用：
$$\theta_{deg} = \mathrm{rad2deg}(\theta) - 360$$
其含义是把 $2\pi$ rad（360°）定义为 TDC（上止点）对应的 0°ATDC，从而方便以“上止点后角度”为横轴描述燃烧放热与压力演化。

### 3.2 状态方程与状态变量选择

零维模型的核心是把缸内混合气体视为理想气体，并用少量状态量描述其平均热力学状态。项目实现的状态向量选取为：
$$\mathbf{y}(\theta) = [T(\theta),\; m(\theta)]^\top$$
即仅显式求解温度 $T$ 与缸内质量 $m$ 的角度域微分方程。压力由状态方程给出：
$$p(\theta) = \frac{m(\theta)\,R\,T(\theta)}{V(\theta)}$$
其中 $V(\theta)$ 来自几何模型。该选择在数值上具有优势：一方面避免了直接对压力微分造成的刚性增强；另一方面允许在存在泄漏故障时，通过 $m(\theta)$ 的动态变化自然反映气密性下降对 $p$ 与 $T$ 的影响。

在物性方面，为兼顾计算效率与物理合理性，项目实现了一个简化的可变比热处理：比热比 $\gamma$ 根据燃烧分数 $x_b$ 在空气与燃气之间线性插值，而定容比热 $c_v$ 以“空气与燃气基值插值 + 高温增大修正”的方式表达。该处理并非严格的组分热力学（例如 NASA 多项式），但能在 0D 框架下提供“燃烧后比热比降低、高温比热升高”的关键趋势，从而改善压力波形与温度水平的合理性。

### 3.3 能量守恒方程与角度域 ODE

对封闭控制体应用热力学第一定律，可写为（角度域形式）：
$$m\,c_v\,\frac{dT}{d\theta} = \frac{dQ_{comb}}{d\theta} - \frac{dQ_{wall}}{d\theta} - p\frac{dV}{d\theta} - \underbrace{h_{out}\,\frac{dm_{out}}{d\theta}}_{\text{泄漏焓流项}}$$
在项目当前版本中，为保持模型简洁，泄漏焓流项在能量方程中被忽略，而泄漏对系统的影响主要通过质量方程 $dm/d\theta$ 进入压力与温度的耦合。这种处理在轻微泄漏条件下通常可接受，但在严重泄漏时会低估因焓流带走能量造成的温度下降，属于后续可增强的方向。

对应的常微分方程写为：
$$\frac{dT}{d\theta} = \frac{\frac{dQ_{comb}}{d\theta} - \frac{dQ_{wall}}{d\theta} - p\frac{dV}{d\theta}}{m\,c_v(T,x_b)}$$
并配套一个简化泄漏质量模型：
$$\frac{dm}{d\theta} = -k_{leak}\,(p - p_{crank}) \quad (p>p_{crank})$$
其中 $k_{leak}$ 与故障注入的泄漏因子相关，$p_{crank}$ 为曲轴箱压力参考值。需要强调的是，本项目的泄漏方程用于演示“质量下降导致压力与温度演化改变”的机理路径，其形式是工程近似而非孔口流量的严格可压缩流动模型。

在数值实现上，燃烧放热率在燃烧模型里以 $\mathrm{J/deg}$ 给出，而 ODE 的自变量是弧度 $\mathrm{rad}$，因此需要单位转换：
$$\frac{dQ}{d\theta}\bigg|_{\mathrm{rad}} = \frac{dQ}{d\theta}\bigg|_{\mathrm{deg}}\cdot\frac{180}{\pi}$$
传热损失先以功率 $\dot Q_{wall}$（W）计算，再通过角速度 $\omega$ 转到角度域能量：
$$\frac{dQ_{wall}}{d\theta} = \frac{\dot Q_{wall}}{\omega},\qquad \omega = \frac{2\pi\,\mathrm{RPM}}{60}$$
模型以角度网格离散（默认 720 点），用 `odeint` 对 ODE 进行数值积分，并在后处理中计算 $P_{max}$、压缩终点压力 $P_{comp}$（TDC 附近取样）以及最大压升相位等衍生指标。

### 3.4 几何与运动学模型：$V(\theta)$ 与 $dV/d\theta$

发动机几何模块采用曲柄连杆机构的精确运动学关系，计算活塞相对上止点位移：
$$x(\theta)=R\left[(1-\cos\theta) + \frac{1}{\lambda_{cr}}\left(1-\sqrt{1-(\lambda_{cr}\sin\theta)^2}\right)\right]$$
其中 $R=S/2$ 为曲柄半径，$\lambda_{cr}=R/L$ 为曲柄连杆比（与连杆比 $L/R$ 互为倒数）。容积为：
$$V(\theta)=V_c + A_p\,x(\theta)$$
而能量方程中关键项 $p\,dV/d\theta$ 需要体积对角度的导数。项目实现对 $x(\theta)$ 解析求导，并乘以活塞面积得到：
$$\frac{dV}{d\theta} = A_p\,\frac{dx}{d\theta}$$
由于二冲程的有效压缩起点不是 BDC，而由 EVC/SPC 决定，因此 $V_c$ 在工程意义上对应“有效压缩比”的余隙容积，且该有效压缩比正是第一阶段校准的主要对象。

### 3.5 双 Wiebe 燃烧模型：预混 + 扩散叠加

船用低速机的燃烧过程通常可以分解为短促的预混段与持续更长的扩散段。本项目采用双 Wiebe 函数叠加来描述累积燃烧分数 $x_b(\theta)$，其单段 Wiebe 函数为：
$$x_{b,i}(\theta)=1-\exp\left[-a\left(\frac{\theta-\theta_{start}}{\Delta\theta_i}\right)^{m_i+1}\right]$$
并通过预混占比 $f_p$ 做线性加权：
$$x_b(\theta)=f_p\,x_{b,p}(\theta)+(1-f_p)\,x_{b,d}(\theta)$$
在实现中，燃烧起始角使用“喷油正时（BTDC）+ 着火延迟”的组合给出。若喷油正时用 $\phi_{inj}$ 表示（单位 deg BTDC），着火延迟为 $\tau_{ign}$（deg），则着火角（deg ATDC）为：
$$\theta_{ign} = -\phi_{inj} + \tau_{ign}$$
瞬时燃烧率由 Wiebe 函数解析导数得到：
$$\frac{dx_{b,i}}{d\theta}=\frac{a(m_i+1)}{\Delta\theta_i}\,\tau^{m_i}\,\exp\left[-a\tau^{m_i+1}\right],\quad \tau=\frac{\theta-\theta_{start}}{\Delta\theta_i}$$
总放热率则为：
$$\frac{dQ_{comb}}{d\theta}=m_f\,LHV\,\eta_{comb}\,\frac{dx_b}{d\theta}$$
其中 $m_f$ 为循环喷油量，$LHV$ 为燃油低热值，$\eta_{comb}$ 为燃烧效率。

![图 3-1 燃烧放热率与累积燃烧分数](../results/fig5_heat_release.png)

**此处插入图 3-1（燃烧放热率与累积燃烧分数，文件：`results/fig5_heat_release.png`）**。图中横轴为 °CA ATDC，蓝色曲线为放热率 $dQ/d\theta$，红色/绿色（视绘图实现）为累积燃烧分数 $x_b$。该图建议在论文中用于说明“双 Wiebe 叠加”的可解释性：预混段对 $P_{max}$ 的峰值高度敏感，而扩散段对排温与膨胀做功更敏感。

### 3.6 Woschni 传热模型：换热系数与表面积近似

缸内对流换热用 Woschni 关联式表示为：
$$h = C\,D^{-0.2}\,p^{0.8}\,T^{-0.53}\,w^{0.8}$$
其中 $D$ 为缸径，$p$ 为缸压，$T$ 为缸温，$w$ 为特征速度。实现中 $p$ 使用 kPa 单位以匹配经典公式标定习惯，因此严格写法应理解为 $p_{kPa}=p/1000$ 后代入。特征速度的构成采用“活塞诱导速度 + 燃烧附加速度”的工程形式：
$$w = C_1\,C_m + w_{comb}$$
$$w_{comb}=C_2\,\frac{V_s\,T_{ref}}{p_{ref}\,V_{ref}}\,(p-p_{motoring})$$
其中 $C_m$ 为平均活塞速度，$p_{motoring}$ 为无燃烧倒拖压力（多变压缩近似），$T_{ref},p_{ref},V_{ref}$ 为参考状态。换热面积采用“活塞顶 + 缸盖 + 缸套侧壁”三部分近似：
$$A\approx A_{piston}+A_{head}+A_{liner}$$
而壁面温度使用三者的平均值形成平均温差驱动。该简化使得模型能在不引入壁温分布与传导方程的情况下，仍具备“温差越大、气体扰动越强换热越强”的基本规律。

排气温度的估算在当前版本中采用“膨胀终点温度 $T_{end}$ 的经验比例”给出：
$$T_{exh}\approx 0.85\,T_{end}$$
该处理主要用于演示“传热校准以排温为目标”的流程。若用于更高精度研究，可进一步引入排气过程热力学与涡轮前后能量交换模型。

![图 3-2 多工况 P–V 示功图](../results/fig2_pv_diagram.png)

**此处插入图 3-2（多工况 P–V 示功图，文件：`results/fig2_pv_diagram.png`）**。该图建议放置在几何与能量方程之后，用于把抽象的 $p\!\sim\!V$ 关系可视化。闭合曲线的面积与指示功相关，工程实现中通过数值积分 $\oint p\,dV$ 计算指示平均有效压力 IMEP。

## 4 三阶段解耦校准：从“可辨识性”出发的参数分解

零维模型的优势在于机理可解释，但其准确性高度依赖参数。不同参数主导不同物理阶段：有效压缩比主要影响压缩末压力；燃烧放热规律主要影响 $P_{max}$ 与压升相位；传热系数主要影响排温与能量平衡。若把所有参数一次性在全工况同时优化，会遇到参数耦合强、目标函数多峰、局部极值多的问题，且容易出现“用不合理参数拟合某一指标”的过拟合现象。因此，本项目采用三阶段解耦校准，将高维问题拆分为三个更可辨识的子问题。

### 4.1 数据预处理与稳态点提取

校准数据来自 CSV 监测记录，系统首先完成列名映射、单位转换与异常值过滤。其中扫气压力与共轨压力由 bar 转换为 Pa，扫气温度根据数值大小判断是否需要从 °C 转换为 K。需要特别注意的是，一些平台的 KPI 列可能并非物理意义上的真实压力，项目实现中对 $P_{comp}$ 提供了一个“物理合理性检查与估算替代”机制：若原始 $P_{comp}$ 的平均水平显著低于基于多变压缩的估算值，则采用估算值替代，以避免在第一阶段校准中被错误数据牵引。

稳态点提取采用滑动窗口计算转速滚动标准差的方式实现。设窗口长度为 $N$，转速序列为 $RPM(t)$，则稳态判据可以表达为：
$$\sigma_{RPM}(t)=\sqrt{\frac{1}{N-1}\sum_{i=0}^{N-1}(RPM(t-i)-\overline{RPM}(t))^2}\;<\;\epsilon_{RPM}$$
当严格稳态点不足时，算法会退化为从最小的 $\sigma_{RPM}$ 片段中抽样，从而保证校准流程在工程数据质量有限时仍可运行。

### 4.2 阶段一：压缩段校准（有效压缩比）

第一阶段在“无燃烧”条件下运行压缩过程，通过调整有效压缩比 $CR$ 使仿真压缩终点压力 $P_{comp,sim}$ 与数据 $P_{comp,exp}$ 的相对误差最小。对单个代表性工况点，目标函数写为：
$$J_1(CR)=\left(\frac{P_{comp,sim}(CR)-P_{comp,exp}}{P_{comp,exp}}\right)^2$$
优化使用带边界的 L-BFGS-B 方法，并在 $CR\in[11,16]$ 的范围内搜索。该阶段的意义不只是“拟合一个数值”，更关键的是校正压缩过程的热力学起跳点，使后续燃烧段校准不会被错误的压缩压力背景所污染。

### 4.3 阶段二：燃烧段校准（喷油正时与扩散段参数）

第二阶段以 $P_{max}$ 为对标目标，优化燃烧模型的关键参数。项目实现选取喷油正时 $\phi_{inj}$（deg BTDC）、扩散燃烧持续角 $\Delta\theta_d$ 与扩散段形状因子 $m_d$ 作为优化变量，并在多个稳态点上累积误差：
$$J_2(\mathbf{x})=\frac{1}{K}\sum_{k=1}^{K}\left(\frac{P_{max,sim}^{(k)}(\mathbf{x})-P_{max,exp}^{(k)}}{P_{max,exp}^{(k)}}\right)^2$$
由于该目标函数通常非凸且可能多峰，项目采用差分进化（Differential Evolution, DE）进行全局搜索。DE 的核心迭代可概括为：从种群中随机取样构造差分向量并变异得到候选解，再进行交叉与择优保留。其典型变异算子为：
$$\mathbf{v}=\mathbf{x}_{r1}+F(\mathbf{x}_{r2}-\mathbf{x}_{r3})$$
DE 的优势在于对噪声与非光滑目标更鲁棒，适合燃烧参数这类“梯度难以稳定计算”的问题。在演示脚本中，为缩短运行时间，迭代次数与种群规模被刻意减小；在论文研究或真实标定时，可相应增大 `maxiter` 与 `popsize` 以提高求解质量。

### 4.4 阶段三：传热段校准（Woschni 系数）

第三阶段以排气温度为对标变量，优化 Woschni 模型主系数 $C_{woschni}$。对具备有效排温数据的稳态点集合，目标函数为：
$$J_3(C_{woschni})=\frac{1}{K}\sum_{k=1}^{K}\left(\frac{T_{exh,sim}^{(k)}(C_{woschni})-T_{exh,exp}^{(k)}}{T_{exh,exp}^{(k)}+273.15}\right)^2$$
其中分母使用 $T_{exp}+273.15$ 是为了把误差相对化并避免低温时数值不稳定。优化同样使用 L-BFGS-B，并对 $C_{woschni}$ 施加合理边界。需要说明的是，当前实现中的 $C_{woschni}$ 的数值范围与“经典公式常数”不必一一对应，因为实现中已包含单位换算、参考状态与壁温近似等工程处理，校准所得系数应理解为“在本模型结构下的等效传热尺度因子”。

![图 4-1 校准验证：Pmax 与 Pcomp 对标](../results/fig1_calibration_verification.png)

**此处插入图 4-1（校准验证：热力参数对标，文件：`results/fig1_calibration_verification.png`）**。需要强调的是：`main.py` 的演示模式为了展示绘图链路，会把“实验值”用“仿真值叠加小幅随机噪声”的方式构造，因此该图在演示运行中呈现的是流程正确性而非真实拟合优度；在实际论文研究中，应替换为真实监测数据的对标结果，并在图注中给出平均相对误差、最大误差及工况覆盖范围。

## 5 故障注入与机理残差诊断：从“偏差”到“故障类型”的可解释映射

### 5.1 故障注入的机理等效方式

为了在仿真环境中系统评估诊断与控制策略，本项目设计了故障注入器，将典型故障以“参数扰动”的形式注入 0D 模型。喷油正时偏差故障通过直接修改燃烧模型中的喷油正时参数实现，其幅值随时间可以是阶跃或斜坡。气缸泄漏故障通过增加质量方程中的泄漏因子实现，从而改变 $m(\theta)$ 的演化并引起压力与温度波形的系统性偏移。燃油系统衰减通过对循环喷油量施加衰减系数实现，进而降低总放热量并导致 $P_{max}$ 降低、排温与做功发生变化。喷油器漂移则同时影响正时与喷油量，体现复合故障的特征。

这种注入方式的价值在于，它把故障与模型参数一一关联，使得“故障 → 物理过程变化 → 指标偏移”的因果链条清晰可追溯，为后续残差方向法提供可解释基础。当然，它也意味着故障模型是一种等效描述：例如真实喷油器故障可能改变喷雾锥角、雾化粒径与着火延迟，而在 0D 层面被等效为正时或总放热量的变化。在论文写作中，建议明确声明这一点，以避免读者将其误解为“对所有微观机理的真实复现”。

### 5.2 残差定义、平滑与阈值判定

诊断模块以“模型输出”作为健康参考，以“测量值”作为待诊断对象。由于不同量纲的绝对误差不可直接比较，项目采用相对残差：
$$r_{Pmax}=\frac{P_{max,meas}-P_{max,model}}{P_{max,model}},\qquad r_{Pcomp}=\frac{P_{comp,meas}-P_{comp,model}}{P_{comp,model}}$$
排温残差在实现中以 $T+273.15$ 做相对化以避免数值问题：
$$r_{Texh}=\frac{T_{exh,meas}-T_{exh,model}}{T_{exh,model}+273.15}$$

船端数据往往含噪且存在短时波动，直接对瞬时残差阈值判定会产生误报。为此，项目对残差序列采用滑动窗口均值平滑：
$$\bar r(t)=\frac{1}{N}\sum_{i=0}^{N-1}r(t-i)$$
并设置普通阈值与临界阈值两级判定。当任一残差绝对值超过普通阈值时进入 FAULT 状态，超过临界阈值进入 CRITICAL 状态。与此同时，诊断器还包含安全限值检查（例如 $P_{max}>190$ bar 或排温超过上限时立即报警），以保证安全约束优先于统计判据。

### 5.3 故障分类：残差方向特征矩阵

在超过阈值触发故障后，系统需要进一步识别故障类型。项目采用“残差方向匹配”的机理分类法：先把残差按符号量化为 $\{-1,0,+1\}$（负/不显著/正），构成残差方向向量：
$$\mathbf{s}=[\mathrm{sign}(r_{Pmax}),\;\mathrm{sign}(r_{Pcomp}),\;\mathrm{sign}(r_{Texh})]$$
再与预先定义的故障特征矩阵进行匹配。例如，喷油正时提前典型表现为 $P_{max}$ 偏高、排温偏低（提前燃烧把热释放更多分配到做功而非排气焓），其方向可写为 $[+1,0,-1]$；正时滞后则相反为 $[-1,0,+1]$。气缸泄漏会降低压缩与燃烧压力并造成排温上升，方向为 $[-1,-1,+1]$。燃油衰减表现为 $P_{max}$ 降低且排温下降（能量输入减少），方向为 $[-1,0,-1]$。匹配度可理解为方向一致项的比例，置信度进一步结合残差幅值进行增强，使得“方向很像但幅值极小”的情况不会被误判为高置信故障。

本方法的突出优势是解释性强且不依赖大量故障样本，适合故障样本稀缺的船机场景；其局限在于当多故障叠加或故障导致的方向特征重叠时，可能需要引入更多观测量（如 $P_{ign}$、IMEP、缸间不均匀指标等）或采用更精细的模式识别方法。

## 6 控诊协同（AFTC）：安全约束驱动的模式切换与协同干预

### 6.1 控制目标、约束与执行机构

在船机运行中，控制目标往往是多目标冲突的：既希望燃油经济性高、功率输出满足推进需求，又必须严格满足安全约束（例如 $P_{max}$ 上限、排温上限）。本项目的协同控制器将最高爆发压力的安全控制作为优先目标，并把喷油正时（VIT）与燃油量作为主要干预手段。选择 VIT 的原因在于其“对 $P_{max}$ 敏感、对功率影响相对温和”，因此在容错控制中被设定为优先执行机构；燃油减量会直接降低功率，通常作为 VIT 饱和后仍无法满足安全约束的次级手段。

控制器内部设定了三条压力线：预警线 $P_{warn}$、硬限值 $P_{limit}$、目标线 $P_{target}$。当 $P_{max}$ 超过预警线或检测到相关故障时进入容错模式；当 $P_{max}$ 超过硬限值时进入紧急模式并实施快速降功保护。

### 6.2 有限状态机：NORMAL / FAULT_TOLERANT / DEGRADED / EMERGENCY

协同控制采用有限状态机（FSM）进行模式管理。NORMAL 模式表示诊断无故障且 $P_{max}$ 远离预警线，控制器维持当前设定。FAULT_TOLERANT 模式对应可恢复或轻度故障（例如喷油正时偏差、燃油衰减）以及 $P_{max}$ 接近预警线的情形，控制器进行 VIT/Pfuel 的协同调节以把 $P_{max}$ 拉回目标线附近。DEGRADED 模式对应严重故障（例如气缸泄漏），控制器采用降级运行策略：识别故障缸并将其负荷视为 0，同时把负荷在健康缸中重新分配，并施加每缸最大增载限制（示例实现中为 15%），从而在保护健康缸的前提下尽可能维持总输出。EMERGENCY 模式则对应 $P_{max}$ 严重超限等高风险情况，控制器立即把 VIT 调至最滞后、燃油快速下调，实现快速降功保护。

### 6.3 容错模式下的 PID 设计：以 $P_{max}$ 为被控量

在容错模式中，控制器以 $P_{max}$ 跟踪目标 $P_{target}$ 为主线，误差定义为：
$$e(t)=P_{max}(t)-P_{target}$$
对 VIT 的调节采用离散 PID 结构（实现中用固定步长近似积分与差分）：
$$\Delta u_{vit}(t)=-(K_p e(t)+K_i\sum e(t)\Delta t+K_d(e(t)-e(t-\Delta t)))$$
负号体现“压力偏高时推迟正时”的控制方向。VIT 调节量施加限幅：
$$u_{vit}\in[u_{min},u_{max}]$$
当 VIT 达到下限且 $P_{max}$ 仍显著偏高时，触发燃油减量环节：
$$\Delta u_{fuel}(t)=-(K_p^{fuel} e(t)+K_i^{fuel}\sum e(t)\Delta t)$$
并限定最大减量以避免瞬间大幅功率损失。

需要指出的是，在 `main.py` 的故障响应演示中，为了把“控制动作—压力回落”的效果用最小成本展示出来，采用了一个简化的“VIT 对 $P_{max}$ 的静态增益”近似（例如每滞后 1° 使 $P_{max}$ 降低约若干 bar）。在论文中可以把它解释为“高层控制律的等效映射”，并强调真实系统中应由更精细的模型或实验标定获得该增益，或者直接把 VIT 影响嵌入 0D 模型的喷油正时参数并重新仿真得到闭环响应。

![图 6-1 故障注入与协同控制响应](../results/fig3_fault_response.png)

**此处插入图 6-1（故障注入与协同控制响应，文件：`results/fig3_fault_response.png`）**。该图建议放在控制策略描述之后，用于展示“故障→Pmax 上冲→诊断触发→控制介入→Pmax 回落”的闭环行为。图中三联子图分别对应故障注入信号、Pmax 开环/闭环对比以及控制动作序列，适合论文对控制效果进行定性说明。

### 6.4 多目标性能权衡的表达：雷达图与指标归一化

为直观表达“安全性优先”的多目标权衡，本项目用雷达图把多个维度的性能指标进行归一化对比。典型维度包括：$P_{max}$ 安全裕度（距离上限的余量）、燃油效率（如 g/kWh，越小越好）、排温裕度、输出功率、转速稳定性（波动幅度，越小越好）。归一化时对“越小越好”的维度进行反向映射，使得雷达图外扩方向一致表示“更优”。

![图 6-2 性能权衡雷达图](../results/fig4_performance_radar.png)

**此处插入图 6-2（性能权衡雷达图，文件：`results/fig4_performance_radar.png`）**。该图建议用于论文中“安全—经济—稳定”的权衡讨论：故障状态下安全裕度显著下降，而协同控制通过牺牲部分功率或效率把安全裕度拉回，同时尽量维持转速稳定。

## 7 论文插图与结果输出的组织建议（与代码输出对齐）

为了保证“代码输出—论文插图—读者复现”三者一致，本项目建议的插图组织如下：校准对标图用于校准章节末尾（图 4-1，对应 `results/fig1_calibration_verification.png`）；P–V 示功图用于模型章节（图 3-2，对应 `results/fig2_pv_diagram.png`）；放热率曲线用于燃烧模型章节（图 3-1，对应 `results/fig5_heat_release.png`）；故障响应三联图用于协同控制章节（图 6-1，对应 `results/fig3_fault_response.png`）；性能雷达图用于控制效果总结（图 6-2，对应 `results/fig4_performance_radar.png`）。

如果论文需要加入“交互式仪表盘”的截图，建议在系统架构章节增加一张界面图（可由运行 `main.py --mode dashboard` 后手动截屏得到），并把截图文件命名为 `results/fig_dashboard.png`，在本章第 2 节末尾作为“工程化展示”补充。

## 8 讨论与局限性

本项目以工程可复现与可解释为优先，因此在若干环节采用了有意识的简化。首先，0D 模型默认只覆盖高压闭合循环的一段角度区间，并以经验比例估算排气温度；这使得模型适合作为诊断与控制策略开发的“快速内核”，但在排气过程、换气效率以及涡轮增压系统耦合方面的精度有限。其次，泄漏故障的能量项采用近似处理，在严重泄漏情况下可能需要引入焓流项或更细致的流量模型。再次，协同控制演示中对 VIT—Pmax 的映射采用线性增益近似；若要用于更严谨的闭环仿真或实际控制器验证，建议把控制动作真正反馈到燃烧模型参数并重新运行循环仿真，或者引入控制导向的线性化模型来推导增益与稳定性。

尽管存在这些局限，本项目仍提供了一条清晰的研究路线：以机理模型为核心建立可解释的健康参考，以解耦校准保证模型在目标指标上的可信度，以残差方向法实现小样本条件下的可解释诊断，以有限状态机与约束优先的控制律实现从“报警”到“主动干预”的闭环跃迁。对于硕士论文而言，这样的结构能够把建模、算法与控制原理贯穿成完整的工程闭环，同时保持足够的数学严谨性与实现可复现性。

---

*本章图表默认由 `main.py --mode demo` 生成并保存在 `results/`。若读者需要快速验证绘图链路，可运行 `quick_demo.py`，其输出文件以 `results/demo_*.png` 命名，但论文正式插图建议统一采用 `fig1~fig5` 的命名体系以便引用与排版。*

