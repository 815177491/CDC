# 船用柴油机故障诊断与协同控制方法研究

## 1. 引言

船用柴油机作为大型远洋船舶的核心动力装置，其运行可靠性和安全性直接关系到船舶的航行安全和经济效益。随着船舶自动化程度的不断提高，传统的"定期维护"模式逐渐向"状态维护"和"预测性维护"转变，这对发动机状态监测、故障诊断和容错控制提出了更高要求。然而，在现有的船舶动力管理系统中，故障诊断模块与控制模块往往相互独立，诊断结果不能及时有效地指导控制策略调整，控制动作也缺乏对潜在故障的预见性考量。这种"诊控分离"的架构在面对复杂故障场景时，可能导致响应滞后、处置不当甚至加剧故障后果。

针对上述问题，本章提出一种"控诊协同"（Collaborative Diagnosis and Control, CDC）的新型架构，将故障诊断与容错控制紧密耦合，实现诊断信息与控制决策的实时交互。在这一架构下，诊断模块不仅负责检测和识别故障，还为控制模块提供故障类型、严重程度和发展趋势等关键信息；控制模块则根据诊断结果动态调整控制策略，在保障安全的前提下尽可能维持发动机性能。这种闭环协同机制能够显著提高系统对故障的响应速度和处置效果，是实现船用柴油机智能运维的重要技术路径。

本章将首先阐述故障诊断的理论基础和实现方法，包括残差分析原理、故障特征矩阵和故障分类算法；随后详细介绍协同控制器的设计思想和控制策略，重点分析两个典型应用场景：最大爆发压力越限协同控制和能效衰退补偿控制；最后通过仿真实验验证协同控制的有效性，并介绍系统输出图表的设计与解读方法。

## 2. 基于残差分析的故障诊断方法

### 2.1 残差诊断原理

故障诊断的核心任务是检测系统是否发生故障、识别故障类型并评估故障严重程度。在基于模型的诊断方法中，残差分析是一种经典而有效的技术手段。其基本思想是：利用系统的数学模型预测正常状态下的输出量，将实际测量值与模型预测值进行比较，二者的差异即为残差。当系统正常运行时，残差应当在一定范围内波动（主要由测量噪声和建模误差引起）；当系统发生故障时，残差将显著偏离正常范围，从而触发故障检测。

残差的数学定义如下：设$\mathbf{Y}_{\text{real}}$为系统的实际输出向量，$\mathbf{Y}_{\text{model}}$为基于健康模型的预测输出向量，则残差向量$\mathbf{r}$定义为：

$$\mathbf{r} = \mathbf{Y}_{\text{real}} - \mathbf{Y}_{\text{model}}$$

对于船用柴油机，选取三个关键热力学参数作为诊断输出量：最大爆发压力$P_{\text{max}}$、压缩终点压力$P_{\text{comp}}$和排气温度$T_{\text{exh}}$。这三个参数能够综合反映发动机的燃烧性能、密封性能和热平衡状态。相应的残差向量为：

$$\mathbf{r} = \begin{bmatrix} r_{P_{\text{max}}} \\ r_{P_{\text{comp}}} \\ r_{T_{\text{exh}}} \end{bmatrix} = \begin{bmatrix} P_{\text{max,real}} - P_{\text{max,model}} \\ P_{\text{comp,real}} - P_{\text{comp,model}} \\ T_{\text{exh,real}} - T_{\text{exh,model}} \end{bmatrix}$$

为了消除量纲影响并便于跨参数比较，通常采用相对残差形式：

$$\tilde{r}_i = \frac{Y_{i,\text{real}} - Y_{i,\text{model}}}{Y_{i,\text{model}}}$$

这样，所有残差都表示为相对于模型预测值的百分比偏差，便于设定统一的阈值进行故障检测。

残差分析的有效性高度依赖于基准模型的准确性。这正是前一章详细阐述的零维模型及其校准方法的价值所在：经过三阶段校准后，模型能够准确预测正常工况下的热力学参数，从而为残差计算提供可靠的基准。当实际测量值与模型预测出现显著偏差时，可以确信这是由系统状态变化（包括故障）引起的，而非模型误差所致。

### 2.2 故障特征矩阵与故障分类

仅仅检测到残差异常还不足以实施针对性的容错控制，还需要进一步识别故障的具体类型。不同类型的故障会在不同的输出参数上产生特征性的残差响应，这种"故障-残差"的对应关系可以总结为故障特征矩阵（Fault Signature Matrix）。

对于船用柴油机，主要考虑以下几类典型故障模式：喷油正时偏差（包括正时提前和正时滞后）、气缸泄漏、燃油系统衰减和喷油器漂移。每种故障对三个诊断参数的影响方向可以通过物理分析和仿真实验确定。故障特征矩阵定义如下：

| 故障类型 | $r_{P_{\text{max}}}$ | $r_{P_{\text{comp}}}$ | $r_{T_{\text{exh}}}$ |
|----------|:--------------------:|:---------------------:|:--------------------:|
| 正时提前 | $+$ | $0$ | $-$ |
| 正时滞后 | $-$ | $0$ | $+$ |
| 气缸泄漏 | $-$ | $-$ | $+$ |
| 燃油衰减 | $-$ | $0$ | $-$ |
| 喷油器漂移 | $-$ | $-$ | $0$ |

表中，"$+$"表示正残差（实际值高于模型预测），"$-$"表示负残差（实际值低于模型预测），"$0$"表示无显著变化。这一特征矩阵的物理解释如下：

喷油正时提前会使燃烧放热相位前移，更多燃料在上止点前燃烧，导致最大爆发压力升高（$r_{P_{\text{max}}} > 0$）。同时，由于燃烧时缸内温度较高，热损失增加，膨胀终点温度降低，排气温度也随之下降（$r_{T_{\text{exh}}} < 0$）。压缩过程在着火前完成，不受喷油正时影响，因此压缩压力残差接近零（$r_{P_{\text{comp}}} \approx 0$）。正时滞后的情况恰好相反。

气缸泄漏导致压缩过程中部分工质逸出，压缩终点压力下降（$r_{P_{\text{comp}}} < 0$）。泄漏同时降低了燃烧室内的工质量和压力水平，使得最大爆发压力也下降（$r_{P_{\text{max}}} < 0$）。然而，由于工质量减少，相同燃料量燃烧产生的温升效果增强，加之泄漏的工质可能携带热量进入曲轴箱再循环，导致排气温度升高（$r_{T_{\text{exh}}} > 0$）。

燃油系统衰减（如喷油量不足或燃油品质下降）导致燃烧放热量减少，最大爆发压力下降（$r_{P_{\text{max}}} < 0$），膨胀过程热量不足，排气温度也下降（$r_{T_{\text{exh}}} < 0$）。压缩过程在喷油前完成，不受燃油问题影响。

基于故障特征矩阵，故障分类算法通过计算当前残差向量与各故障特征的匹配程度来识别故障类型。首先将残差向量符号化：

$$\text{sign}(r_i) = \begin{cases} +1, & r_i > \delta \\ -1, & r_i < -\delta \\ 0, & |r_i| \leq \delta \end{cases}$$

其中$\delta$为符号化阈值，用于滤除噪声引起的微小残差。然后计算符号化残差向量与各故障特征向量的匹配分数：

$$\text{Score}_j = \frac{\sum_{i} \mathbb{1}[\text{sign}(r_i) = s_{j,i} \text{ 且 } s_{j,i} \neq 0]}{\sum_{i} \mathbb{1}[s_{j,i} \neq 0]}$$

式中，$s_{j,i}$为第$j$类故障在第$i$个参数上的特征符号，$\mathbb{1}[\cdot]$为指示函数。匹配分数最高的故障类型即为诊断结果。

除了故障类型识别，还需要评估诊断的置信度。置信度综合考虑匹配分数和残差幅值：

$$\text{Confidence} = \min\left( \text{Score}_{\text{best}} \times (1 + k \cdot \bar{|r|}), 1 \right)$$

其中$\bar{|r|}$为残差绝对值的平均值，$k$为放大系数（典型值为5）。这一设计使得在残差幅值较大时（故障较严重），即使匹配分数稍低，置信度也能得到提升。

*【图1插入位置：故障诊断流程图，包括残差计算、阈值检测、特征匹配和故障分类步骤，建议放置于../results/fig_diagnosis_flowchart.png】*

### 2.3 阈值设计与状态分级

合理的阈值设计对于平衡故障检测的灵敏度和误报率至关重要。阈值设置过低会导致正常运行中的测量噪声频繁触发误报；阈值设置过高则可能延误对早期故障的检测。本研究采用双阈值机制，将诊断状态分为四个等级：

健康状态（HEALTHY）：所有参数的相对残差均在正常阈值以内，表示系统运行正常。正常阈值的典型设置为：$P_{\text{max}}$残差不超过3%，$P_{\text{comp}}$残差不超过2%，$T_{\text{exh}}$残差不超过5%。

警告状态（WARNING）：某个或某些参数的残差超过正常阈值但未达到临界阈值，表示系统可能存在轻微异常或处于故障发展初期。此时应加强监测并准备启动容错控制。

故障状态（FAULT）：残差超过正常阈值且故障分类算法能够识别出明确的故障类型，表示系统确认发生故障。应立即启动对应的容错控制策略。

临界状态（CRITICAL）：残差达到临界阈值（通常为正常阈值的2至3倍），或者测量值超过绝对安全限值（如$P_{\text{max}} > 190$ bar或$T_{\text{exh}} > 450$°C）。此时必须立即执行紧急保护措施，如快速降功或停机。

阈值的具体数值需要根据发动机特性和运行经验确定。临界阈值的典型设置为：$P_{\text{max}}$残差8%，$P_{\text{comp}}$残差5%，$T_{\text{exh}}$残差10%。绝对安全限值则根据发动机制造商的技术规范确定。

诊断状态的确定采用"最严重优先"原则：只要有一个参数的状态达到较高等级，整体诊断状态就定为该等级。例如，如果$P_{\text{max}}$处于故障状态而其他参数正常，则整体状态仍为故障。

### 2.4 滑动窗口平滑与趋势分析

实际测量数据往往包含噪声和瞬态扰动，直接使用瞬时残差进行诊断可能导致结果不稳定。为此，引入滑动窗口平滑机制对残差进行时序滤波。

设窗口大小为$N$（典型值为10个采样点），滑动窗口内的残差序列为$\{r_i(t), r_i(t-1), \ldots, r_i(t-N+1)\}$，则平滑后的残差为：

$$\bar{r}_i(t) = \frac{1}{N} \sum_{k=0}^{N-1} r_i(t-k)$$

平滑后的残差消除了高频噪声的干扰，更准确地反映了残差的趋势性变化。故障分类和状态判定均基于平滑残差进行。

滑动窗口还可用于趋势分析。通过计算残差的变化率（导数）或拟合直线斜率，可以判断故障是处于稳定状态还是正在发展恶化。如果残差呈持续上升趋势，即使当前值尚未达到临界阈值，也应提高警惕并考虑提前采取预防措施。

### 2.5 诊断结果输出与建议生成

诊断模块的输出不仅包括故障检测结果和故障类型，还应提供人机友好的处理建议，以辅助操作人员或自动控制系统做出决策。诊断结果数据结构包含以下字段：时间戳、是否检测到故障、故障类型、置信度、各参数残差值和处理建议。

处理建议根据故障类型和诊断状态自动生成。对于喷油正时偏差，建议调整VIT（可变喷油正时）进行补偿；对于气缸泄漏，建议安排停机检修活塞环和缸套；对于燃油系统衰减，建议检查喷油器和燃油滤清器；对于喷油器漂移，建议重新校准或更换喷油器。在临界状态下，建议立即降功或启动协同控制进行保护。

诊断结果通过诊断历史队列进行记录，便于后续的趋势分析和故障回溯。同时，诊断状态以可视化指示灯的形式呈现：绿色表示正常，黄色表示警告，橙色表示故障，红色表示临界。这种直观的状态展示有助于操作人员快速把握系统运行状况。

## 3. 协同控制器设计

### 3.1 协同控制架构

协同控制器（Synergy Controller）是连接故障诊断与容错控制的核心组件，其设计目标是：根据诊断模块提供的故障信息，实时调整控制策略，在保障安全的前提下最大程度维持发动机性能。与传统的被动容错控制（仅在故障发生后进行补偿）不同，协同控制器能够在故障发展初期就主动介入，通过前馈和反馈相结合的方式实现"早发现、早干预"。

协同控制器的输入包括：来自诊断模块的诊断结果（故障类型、置信度）、来自传感器的实时测量值（$P_{\text{max}}$、$P_{\text{comp}}$、$T_{\text{exh}}$）以及系统设定值（目标转速、安全限值）。输出包括：VIT调整量、燃油调整量、功率限制系数和各缸使能状态。

控制器运行在闭环模式下，每个控制周期执行以下序列：首先调用诊断模块进行故障诊断；然后根据诊断结果和当前测量值更新控制模式；接着执行与当前模式对应的控制算法；最后将控制动作应用于执行机构并记录控制历史。

控制模式分为四种：正常模式（NORMAL）下保持当前控制参数不变；容错模式（FAULT_TOLERANT）下启动VIT和燃油的协调调整；降级模式（DEGRADED）下在健康气缸之间重新分配负荷；紧急模式（EMERGENCY）下执行快速降功保护。模式切换的条件由诊断状态和$P_{\text{max}}$测量值共同决定。

### 3.2 控制模式切换逻辑

控制模式的自动切换是协同控制的关键机制。切换逻辑遵循以下规则：

当$P_{\text{max}}$超过硬限值（190 bar）时，无论诊断结果如何，立即进入紧急模式。这是最高优先级的安全保护，任何故障都不能阻止这一切换。

当诊断模块检测到喷油正时故障或燃油系统故障时，进入容错模式。此外，当$P_{\text{max}}$超过预警值（180 bar）但未达到硬限值时，也进入容错模式进行预防性调整。

当诊断模块检测到气缸泄漏故障时，进入降级模式。因为气缸泄漏通常无法通过调整控制参数来修复，只能通过降低故障缸负荷来避免损坏扩大。

当诊断状态为健康且$P_{\text{max}}$在正常范围内时，保持或恢复正常模式。

模式切换具有一定的滞后性设计，避免在故障边界附近频繁切换造成控制振荡。例如，从容错模式恢复到正常模式需要$P_{\text{max}}$连续多个周期低于预警值。

### 3.3 场景A：Pmax越限协同控制

最大爆发压力$P_{\text{max}}$是柴油机最重要的机械载荷指标，过高的$P_{\text{max}}$会加速活塞、连杆和曲轴等运动部件的疲劳损伤，严重时可能导致机械故障。因此，$P_{\text{max}}$越限控制是协同控制的首要任务。

$P_{\text{max}}$越限控制的策略是：优先调整VIT（可变喷油正时）来降低$P_{\text{max}}$，若VIT调整量已达饱和仍不能满足要求，再减少燃油喷射量。这一优先级设计的原因在于：VIT调整是一种"低成本"干预，不影响发动机的功率输出，仅改变燃烧相位；而减少燃油则直接降低功率，是一种"高成本"措施，只有在必要时才使用。

VIT调整采用PID控制算法。设$P_{\text{max}}$的目标值为$P_{\text{max,target}}$（如170 bar，留有足够的安全裕度），误差为：

$$e(t) = P_{\text{max,meas}}(t) - P_{\text{max,target}}$$

VIT调整量的增量为：

$$\Delta \theta_{\text{VIT}} = -\left( K_p \cdot e(t) + K_i \cdot \int_0^t e(\tau) d\tau + K_d \cdot \frac{de(t)}{dt} \right)$$

式中，$K_p$、$K_i$、$K_d$分别为比例、积分、微分增益。负号表示正误差（$P_{\text{max}}$偏高）时应推迟喷油（VIT负向调整）以降低$P_{\text{max}}$。VIT调整量需进行限幅处理，以防止超出执行机构的物理范围：

$$\theta_{\text{VIT}} = \text{clip}(\theta_{\text{VIT,current}} + \Delta \theta_{\text{VIT}}, \theta_{\text{VIT,min}}, \theta_{\text{VIT,max}})$$

典型的VIT调整范围为$-8°$至$+4°$相对于标定正时。

当VIT调整量达到下限（最大推迟）而$P_{\text{max}}$仍高于目标值（误差大于一定阈值，如5 bar）时，启动燃油调整：

$$\Delta f_{\text{fuel}} = -\left( K_{p,f} \cdot e(t) + K_{i,f} \cdot \int_0^t e(\tau) d\tau \right)$$

燃油调整量表示相对于正常喷油量的比例变化，典型范围为$-30\%$至$0\%$（只减不增）。

通过VIT和燃油的协调控制，可以在大多数情况下将$P_{\text{max}}$控制在安全范围内。控制器记录每次控制干预的动作，用于后续的性能分析和策略优化。

*【图2插入位置：Pmax越限协同控制原理框图，包括诊断模块、PID控制器、VIT执行器和燃油执行器，建议放置于../results/fig_pmax_control_block.png】*

### 3.4 场景B：能效衰退补偿控制

当诊断模块检测到某缸存在气缸泄漏故障时，该缸的做功能力下降，不仅影响总功率输出，还可能导致缸间负荷不均衡。能效衰退补偿控制的目标是：在故障缸运行受限的情况下，通过在健康气缸之间重新分配负荷，尽可能维持发动机的总功率输出。

降级模式下的负荷重分配算法如下：首先识别故障缸（根据残差分析确定做功不足的气缸）；然后将故障缸的负荷设为零或最小值；最后将故障缸原有的负荷平均分配给健康气缸。

设发动机有$n$个气缸，故障缸编号为$k$，其原负荷系数为$\lambda_k$，健康气缸数量为$n-1$（假设仅一缸故障），则负荷重分配后各缸负荷系数为：

$$\lambda_i' = \begin{cases} 0, & i = k \\ \lambda_i + \frac{\lambda_k}{n-1}, & i \neq k \end{cases}$$

考虑到各缸的过载能力有限（通常不超过额定负荷的115%），需要对重分配后的负荷进行限幅：

$$\lambda_i' = \min(\lambda_i', \lambda_{\text{max}})$$

如果所有健康缸均达到过载上限仍不能完全补偿故障缸的负荷损失，则总功率将不可避免地下降。功率损失率可计算为：

$$\eta_{\text{loss}} = 1 - \frac{\sum_{i \neq k} \lambda_i'}{n \cdot \bar{\lambda}}$$

控制器记录功率损失率，并在控制动作中报告当前的功率限制系数（$1 - \eta_{\text{loss}}$）。

在实际实施中，各缸负荷的调整通常通过电控喷油系统实现：增加健康缸的单次喷油量以提高其做功输出，同时减少或停止故障缸的喷油以避免损坏扩大。控制器输出的"各缸使能状态"（cylinder_mask）用于指示各缸是否参与做功。

### 3.5 紧急保护机制

紧急模式是控制器的最后一道安全防线，当$P_{\text{max}}$严重超限或诊断状态达到临界时触发。紧急模式下的控制策略是：以最快速度降低发动机负荷，牺牲性能以保障安全。

紧急保护的动作包括：VIT立即调整到最大推迟位置（$\theta_{\text{VIT}} = \theta_{\text{VIT,min}}$），以最大程度降低$P_{\text{max}}$；燃油快速削减，每个控制周期减少10%直至达到最低限值（通常为70%）；向上位控制系统发送报警信号，请求降速或停机。

紧急模式的退出条件较为严格：$P_{\text{max}}$必须连续多个周期（如10个周期）低于预警值，且诊断状态不再为临界，才能切换到容错模式或正常模式。这一设计防止了系统在紧急边界附近反复切换。

### 3.6 控制器性能评估指标

为了量化评估协同控制的效果，定义以下性能指标：

$P_{\text{max}}$越限次数：统计$P_{\text{max}}$超过硬限值（190 bar）的事件数量。协同控制的目标是将这一指标降至零。

控制干预次数：统计控制器进行主动调整（VIT或燃油变化）的次数。过多的干预可能意味着故障较严重或控制参数需要调优。

平均VIT调整量：反映控制器为应对故障或$P_{\text{max}}$偏高而进行的正时调整幅度。

平均燃油削减比例：反映控制器因安全限制而牺牲的功率输出。

总功率损失：在降级模式下，由于故障缸退出和健康缸过载限制导致的总功率下降百分比。

这些指标在控制仿真结束后汇总输出，用于评价不同控制策略的优劣和调优控制参数。

## 4. 故障注入与仿真验证

### 4.1 故障注入模块设计

为了验证诊断和控制算法的有效性，需要在仿真环境中可控地引入各类故障。故障注入模块提供了这一能力，它能够在发动机模型中模拟喷油正时偏差、气缸泄漏、燃油衰减等故障模式。

故障注入采用"故障剖面"（Fault Profile）的概念来描述故障的时间特性。每个故障剖面包含以下要素：故障类型（FaultType）、故障严重程度（severity，归一化到0至1）、故障发生时刻（onset_time）和故障发展时间（ramp_time）。故障严重程度可以是阶跃变化（ramp_time = 0）或斜坡变化（ramp_time > 0），后者用于模拟渐进性故障的发展过程。

当前时刻的故障幅值由以下函数计算：

$$\text{magnitude}(t) = \begin{cases} 0, & t < t_{\text{onset}} \\ \text{severity} \cdot \min\left(\frac{t - t_{\text{onset}}}{t_{\text{ramp}}}, 1\right), & t \geq t_{\text{onset}} \end{cases}$$

故障注入器将故障幅值转换为模型参数的修改。对于喷油正时偏差，故障幅值乘以最大偏差角度（如5°）作为正时偏移量叠加到标定正时上；对于气缸泄漏，故障幅值乘以最大泄漏因子（如0.1，对应10%泄漏率）设置到热力学求解器的泄漏参数上；对于燃油衰减，故障幅值对应燃油可用率的下降（如0.3，对应燃油量下降30%）。

故障注入模块还提供了便捷的工厂方法来创建典型故障剖面：create_timing_fault创建喷油正时故障，create_leak_fault创建气缸泄漏故障，create_fuel_fault创建燃油衰减故障。这些方法接受工程师友好的参数（如正时偏差度数、泄漏百分比）并自动转换为归一化的故障剖面。

### 4.2 协同控制仿真实验

利用故障注入模块和协同控制器，可以进行完整的协同控制仿真实验。仿真实验的典型流程如下：

首先，初始化发动机模型、诊断器和协同控制器，设定基准工况（转速、扫气压力、扫气温度、喷油量）。

其次，创建故障剖面，指定故障类型、发生时刻、严重程度和发展特性。例如，模拟在第20秒开始发生正时提前2°的故障。

然后，进行时间步进仿真。在每个时间步内：应用当前时刻的故障；运行发动机循环仿真获取热力学参数；调用协同控制器的update方法执行诊断和控制；记录无控制情况下的$P_{\text{max}}$（开环响应）和有协同控制情况下的$P_{\text{max}}$（闭环响应）；记录控制动作（VIT调整量、燃油调整量）。

最后，仿真结束后，整理时序数据并生成可视化图表，对比开环和闭环响应，评估协同控制效果。

仿真参数的典型设置为：仿真时长100秒，时间步长1秒，故障在第25秒发生，严重程度对应正时提前2°或泄漏5%。

### 4.3 仿真结果分析

通过仿真实验，可以定量分析协同控制的效果。以喷油正时提前故障为例，典型的仿真结果如下：

在无控制（开环）情况下，正时提前导致$P_{\text{max}}$从正常的165 bar逐渐升高，在故障完全发展后达到185至190 bar，接近或超过安全限值。如果故障严重程度更大，$P_{\text{max}}$将严重超限。

在协同控制（闭环）情况下，控制器检测到$P_{\text{max}}$上升后，自动推迟VIT以补偿正时提前的影响。VIT调整量随故障幅值增大而增大，最终稳定在与故障偏差相当的反向值（如故障提前2°，VIT调整量约为-2°）。经过短暂的调节过程，$P_{\text{max}}$被控制在目标值（170 bar）附近，安全裕度得到保障。

对比开环和闭环响应可以发现：协同控制显著降低了$P_{\text{max}}$越限风险，$P_{\text{max}}$峰值降低约15至20 bar；控制器响应迅速，从故障发生到控制介入的延迟约为2至3个控制周期；在稳态时，协同控制下的$P_{\text{max}}$保持在目标值附近，波动幅度小于5 bar。

*【图3插入位置：故障响应时序图（fig3_fault_response.png），建议放置于../results/fig3_fault_response.png。该图应包含三个子图：(A)故障注入信号随时间的变化；(B)$P_{\text{max}}$的开环响应、闭环响应和安全限值对比；(C)VIT和燃油的控制调整量。】*

## 5. 性能权衡与可视化输出

### 5.1 多目标性能权衡分析

船用柴油机的运行涉及多个相互关联甚至相互矛盾的性能目标：安全性（如$P_{\text{max}}$不超限）、经济性（如燃油消耗率最低）、动力性（如功率输出最大）和可靠性（如转速稳定、热负荷合理）。协同控制的本质是在这些目标之间进行动态权衡，在故障或异常工况下优先保障安全性，同时尽量减少对其他性能的负面影响。

为了直观展示这种多目标权衡关系，采用雷达图（Radar Chart）进行可视化。雷达图以极坐标形式呈现多个维度的性能指标，每个维度从圆心向外延伸，数值越大表示性能越好。通过对比不同状态下的雷达图形态，可以清晰地看出性能的变化和取舍。

本研究定义五个性能评价维度：

$P_{\text{max}}$安全裕度：定义为$(P_{\text{max,limit}} - P_{\text{max,actual}})$，表示距安全限值的距离，值越大越安全。

燃油效率：以制动比油耗（BSFC, g/kWh）的倒数表示，值越大表示燃油效率越高。

排温裕度：定义为$(T_{\text{exh,limit}} - T_{\text{exh,actual}})$，表示距排温限值的距离。

输出功率：以额定功率的百分比表示。

转速稳定性：以转速波动幅度的倒数表示，波动越小表示稳定性越好。

各维度的原始值需要归一化到$[0, 1]$区间，以便在雷达图上统一呈现。归一化方法根据维度特性设计：对于"越大越好"的维度（如安全裕度、功率），采用正向归一化；对于"越小越好"的维度（如燃油消耗、转速波动），采用反向归一化。

$$\text{norm}_i = \frac{x_i - x_{i,\min}}{x_{i,\max} - x_{i,\min}} \quad \text{或} \quad \text{norm}_i = 1 - \frac{x_i - x_{i,\min}}{x_{i,\max} - x_{i,\min}}$$

*【图4插入位置：性能权衡雷达图（fig4_performance_radar.png），建议放置于../results/fig4_performance_radar.png。该图应展示三种状态的雷达图叠加：正常基准（绿色虚线）、故障发生时（红色实线填充）、协同控制后（蓝色实线填充）。】*

雷达图的典型解读如下：正常基准状态下，雷达图呈现较为均衡的多边形，各维度性能良好；故障发生时，$P_{\text{max}}$安全裕度急剧收缩（因$P_{\text{max}}$升高），雷达图在该方向明显内凹；协同控制后，$P_{\text{max}}$安全裕度恢复，但燃油效率和输出功率可能略有下降（因VIT推迟和/或燃油削减），雷达图整体形态介于前两者之间，体现了"牺牲少量经济性以保障安全性"的控制策略。

### 5.2 系统输出图表设计

本系统设计了一套完整的可视化图表，用于展示模型校准、仿真分析和协同控制的结果。这些图表既可用于研究论文的插图，也可作为工程应用中的人机界面输出。以下详细介绍各图表的设计意图和内容构成。

**图表1：热力参数对标图（fig1_calibration_verification.png）**

该图用于验证零维模型的校准精度，展示仿真值与实验值的对比。图表采用双Y轴设计：左轴绑制$P_{\text{max}}$的仿真值和实验值，右轴绑制$P_{\text{comp}}$的仿真值和实验值。横轴为工况编号。仿真值用实线圆点表示，实验值用虚线方块表示，两者的偏差可直观判断。图中还绘制了$\pm 3\%$误差带（浅绿色填充区域），校准成功的标志是所有仿真点落在误差带内。图表右下角标注$P_{\text{max}}$和$P_{\text{comp}}$的平均相对误差。

*【该图应放置于../results/fig1_calibration_verification.png】*

**图表2：P-V示功图（fig2_pv_diagram.png）**

示功图是发动机热力学分析的经典图表，横轴为气缸容积（L），纵轴为缸内压力（bar）。图中叠加多个工况的P-V环，使用渐变色区分不同工况（如从低负荷到高负荷）。示功图的面积代表循环功，形态反映压缩比、燃烧相位和膨胀过程特性。通过对比不同工况的示功图形态，可以分析负荷变化对发动机性能的影响。

*【该图应放置于../results/fig2_pv_diagram.png】*

**图表3：故障响应时序图（fig3_fault_response.png）**

该图是协同控制效果展示的核心图表，采用三子图垂直排列的布局：

子图(A)展示故障注入信号随时间的变化，纵轴为故障幅值（如正时偏差度数），横轴为时间。阶跃故障呈现为突变，斜坡故障呈现为渐变上升。

子图(B)展示$P_{\text{max}}$的响应对比，绑制三条曲线：正常基准线（绿色）、无控制开环响应（红色）和协同控制闭环响应（蓝色）。同时绘制安全限值（190 bar，红色虚线）和预警值（180 bar，橙色点线）。开环响应展示故障导致$P_{\text{max}}$上升并可能越限的趋势，闭环响应展示协同控制成功抑制$P_{\text{max}}$的效果。

子图(C)展示控制动作随时间的变化，左轴绑制VIT调整量（蓝色实线），右轴绑制燃油调整量（红色虚线）。该子图直观展示控制器的干预过程和调节动态。

*【该图应放置于../results/fig3_fault_response.png】*

**图表4：性能权衡雷达图（fig4_performance_radar.png）**

如前所述，该图以极坐标雷达图形式展示五个性能维度的权衡关系，对比正常基准、故障发生时和协同控制后的性能形态变化。

*【该图应放置于../results/fig4_performance_radar.png】*

**图表5：燃烧放热率曲线（fig5_heat_release.png）**

该图展示燃烧放热特性，采用双Y轴设计。左轴绑制放热率$dQ/d\theta$（kJ/°CA）随曲轴转角的变化，呈现预混燃烧峰和扩散燃烧区的典型双峰形态。右轴绘制累积燃烧分数$x_b$（%）随曲轴转角的变化，呈现S形曲线从0%上升到100%。横轴为曲轴转角（°CA ATDC），TDC处（0°）用虚线标注。该图有助于理解双Wiebe燃烧模型的拟合效果和燃烧相位特性。

*【该图应放置于../results/fig5_heat_release.png】*

### 5.3 交互式仪表盘

除了静态图表外，本系统还提供了基于Matplotlib的交互式仪表盘，用于实时探索发动机性能和协同控制效果。仪表盘采用多面板布局：左侧面板包含输入滑块（RPM调节、故障程度调节）和控制按钮；中间面板实时显示P-V示功图和燃烧放热率曲线；右侧面板显示诊断状态指示灯（颜色编码）和关键参数数值（$P_{\text{max}}$、$P_{\text{comp}}$、$T_{\text{exh}}$、VIT调整量）。

用户可以通过拖动滑块调节发动机转速和故障程度，观察图表和参数的实时变化。这种交互式探索有助于直观理解故障对发动机性能的影响以及协同控制的补偿效果。仪表盘的启动命令为`python main.py --mode dashboard`。

## 6. 本章小结

本章详细介绍了船用柴油机故障诊断与协同控制的理论方法和实现技术。主要研究内容和结论如下：

第一，建立了基于残差分析的故障诊断框架。通过比较实际测量值与零维模型预测值的差异，计算$P_{\text{max}}$、$P_{\text{comp}}$和$T_{\text{exh}}$三个关键参数的残差。设计了故障特征矩阵，将残差向量的符号模式与特定故障类型相对应，实现了喷油正时偏差、气缸泄漏、燃油衰减等典型故障的自动分类。采用双阈值机制将诊断状态分为健康、警告、故障和临界四个等级，并通过滑动窗口平滑消除测量噪声的干扰。

第二，设计了控诊协同控制器架构。控制器接收诊断模块的故障信息和传感器测量值，根据控制模式切换逻辑选择相应的控制策略。针对$P_{\text{max}}$越限问题，设计了VIT优先、燃油补充的分级控制策略，采用PID算法实现闭环调节；针对气缸故障导致的能效衰退，设计了负荷重分配算法，在健康气缸之间均衡分担故障缸的负荷；针对严重超限情况，设计了紧急保护机制，快速降功以保障安全。

第三，开发了故障注入模块，支持阶跃和斜坡两种故障模式，能够在仿真环境中可控地模拟各类故障场景。通过协同控制仿真实验，定量验证了控制策略的有效性：在正时提前故障下，协同控制成功将$P_{\text{max}}$控制在目标值附近，避免了开环情况下可能发生的越限风险。

第四，设计了一套完整的可视化输出图表体系，包括热力参数对标图、P-V示功图、故障响应时序图、性能权衡雷达图和燃烧放热率曲线。这些图表以直观的方式展示模型精度、仿真结果和控制效果，既可用于研究论文的插图，也可作为工程应用中的人机界面输出。

本章建立的控诊协同控制框架实现了故障诊断与容错控制的紧密耦合，克服了传统"诊控分离"架构响应滞后的缺陷，为船用柴油机的智能运维提供了理论和技术支撑。后续研究可进一步拓展故障类型覆盖范围、优化控制参数自整定机制，以及开展实船验证试验。

*【图5插入位置：燃烧放热率曲线（fig5_heat_release.png），建议放置于../results/fig5_heat_release.png】*

*【图6插入位置：控诊协同系统总体架构图，建议放置于../results/fig_cdc_architecture.png】*
